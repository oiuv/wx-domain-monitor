# 微信域名拦截检测工具

## 简介

这是微信域名拦截检测工具的Python实现，通过调用腾讯官方接口检测域名在微信中是否被封禁。支持单次检测和定时监控两种模式。

```python
check_url = 'https://cgi.urlsec.qq.com/index.php?m=url&a=validUrl&url=' + quote(url)
response = requests.get(check_url, headers=headers, timeout=10)
data = response.json()
```

## 功能特点

- ✅ 调用腾讯官方安全检测接口
- ✅ 基于 `reCode` 字段判断域名状态
- ✅ 支持单次交互式检测
- ✅ 支持定时自动监控（每分钟检测）
- ✅ 异常自动发送企业微信群通知
- ✅ 热重载域名列表（无需重启）
- ✅ 检测结果持久化存储
- ✅ 返回JSON格式结果（包含status字段）
- ✅ 完善的错误处理和超时控制

## 文件说明

### 1. domain_check.py
交互式命令行版本，适用于单次检测和调试。
- 显示从腾讯接口返回的原始响应数据
- 显示处理后的结果（包含status字段）
- 显示reCode状态码及说明
- 异常时自动发送微信群通知

### 2. domain_monitor.py
定时监控版本，适用于持续监控域名状态。
- 每分钟自动检测域名列表中的所有域名
- 检测到异常时自动发送企业微信群通知
- 支持热重载域名列表（修改domains.txt立即生效）
- 检测结果自动保存到JSON文件
- 控制台实时显示检测进度和统计信息

### 3. domains.txt
域名列表文件，每行一个域名。
- 支持注释行（以 # 开头）
- 修改后无需重启程序，下次检测自动生效
- 需要手动创建：复制 `domains.example.txt` 为 `domains.txt` 并添加您的域名

## 依赖安装

```bash
pip install requests
```

## 使用方法

### 方法一：单次检测（domain_check.py）

适用于临时检测单个域名，查看详细响应数据。

```bash
python domain_check.py
```

**运行示例：**
```
==================================================
微信域名拦截检测工具
==================================================

请输入要检测的域名或URL（输入'quit'退出）: example.com

🔍 正在检测域名: example.com
--------------------------------------------------

📦 原始响应数据:
{
  "data": "微信拦截，请联系微信申诉",
  "reCode": -203
}

📝 处理后结果:
{
  "code": 200,
  "msg": "微信拦截，请联系微信申诉",
  "status": "abnormal"
}

📊 状态码: -203 - 异常 - 微信拦截（需要申诉）

❌ 微信拦截，请联系微信申诉
   💬 发送异常通知到微信群...
✅ 异常通知已发送到微信群
--------------------------------------------------
```

### 方法二：定时监控（domain_monitor.py）

适用于持续监控多个域名，自动预警。

**步骤1：配置域名列表**
复制示例文件并添加您的域名：
```bash
# 复制示例文件
cp domains.example.txt domains.txt

# 编辑 domains.txt 文件，添加您的监控域名
```

`domains.txt` 格式示例：
```
# 域名列表文件
# 每行一个域名，以 # 开头的行为注释

example.com
www.baidu.com
# github.com  # 注释的域名不会被检测
```

**步骤2：启动监控程序**
```bash
python domain_monitor.py
```

**运行示例：**
```
============================================================
微信域名定时监测工具已启动
检测间隔：60 秒
按 Ctrl+C 可以停止程序
============================================================

[2025-10-31 16:01:46] 🔍 开始检测 3 个域名...
检测 example.com ... ❌ 异常 - 微信拦截，请联系微信申诉
   💬 发送异常通知到微信群...
✅ 异常通知已发送到微信群
检测 www.baidu.com ... ✅ 正常 - 没有拦截该网址
检测 github.com ... ✅ 正常 - 没有拦截该网址

📊 本次检测完成：
   ✅ 正常：2 个
   ❌ 异常：1 个
   ⚠️ 未知：0 个

💾 检测日志已保存到 logs/2025-10-31.json

⏱️ 等待 60 秒后进行下次检测...
```

#### 监控特性

- **热重载**：修改 `domains.txt` 后无需重启，下次检测自动生效
- **实时通知**：检测到异常时立即发送企业微信群通知
- **日志保存**：检测结果自动保存到 `logs/YYYY-MM-DD.json` 文件
- **状态统计**：每次检测完成后显示正常、异常、未知域名数量
- **自动循环**：每60秒自动检测一次，持续监控

## 原始响应示例

从腾讯接口返回的完整数据：
```json
{
  "data": "没有拦截该网址",
  "reCode": -202
}
```

```json
{
  "data": "微信拦截，请联系微信申诉",
  "reCode": -203
}
```

```json
{
  "data": "ok",
  "reCode": 0
}
```

```json
{
  "data": "不是合法的网址链接",
  "reCode": -201
}
```

> **说明：** 原始响应中 `data` 字段保持不变，直接显示原始数据。仅在微信群通知中对异常情况统一返回 "微信拦截，请联系微信申诉" 提示。

## 判断逻辑说明

### 基于 reCode 字段的判断

腾讯接口返回的 `reCode` 字段用于判断域名状态：

| reCode 值 | 原始返回消息 | 含义 | 域名状态 | 微信内显示效果 |
|-----------|-------------|------|----------|----------------|
| -202 | "没有拦截该网址" | 没有拦截该网址 | ✅ 正常 | 正常访问 |
| -203 | "微信拦截，请联系微信申诉" | 微信拦截，请联系微信申诉 | ❌ 异常 | 显示"如需浏览，请长按网址复制后使用浏览器访问" |
| 0 | "ok" | 风险网址拦截（链接可能包含不安全的内容） | ❌ 异常 | 两种情况：<br>1. 直接拦截显示"已停止访问该网页，网页存在安全风险"<br>2. 显示"无法确认该网页的安全性，请谨慎访问"，有"继续访问"按钮 |
| -201 | "不是合法的网址链接" | 输入的URL格式不正确 | ⚠️ 输入错误 | 不处理，显示原始错误信息 |

### 显示逻辑说明

根据不同的reCode值，控制台显示不同的状态信息：
- **reCode = -202**：显示 "✅ 正常 - [原始消息]"
- **reCode = -203**：显示 "❌ 异常 - [原始消息]"
- **reCode = 0**：显示 "❌ 异常 - 风险网址拦截，链接可能包含不安全的内容"
- **reCode = -201**：显示 "⚠️ 未知 - reCode: -201, msg: [原始消息]"

### 通知逻辑说明

仅在微信群通知中对异常情况发送对应提示：
- **reCode = -203**：发送通知，消息内容为原始API返回消息
- **reCode = 0**：发送通知，消息内容为 "风险网址拦截，链接可能包含不安全的内容"
- **reCode = -202 和 -201**：不发送通知

## 企业微信通知配置

两个工具都支持异常通知功能，检测到域名被微信拦截时会自动发送通知到企业微信群。

**配置方法：**
复制示例文件并修改配置：
```bash
# 复制配置文件模板
cp config.example.py config.py

# 编辑 config.py 文件，填入您的配置
```

`config.py` 配置项：
```python
# 企业微信机器人Webhook地址
WEBHOOK_URL = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=你的机器人密钥"

# 需要通知的同事配置
NOTIFICATION_CONFIG = {
    "mentioned_list": ["用户ID1", "用户ID2"],
    "mentioned_mobile_list": ["手机号1", "手机号2"]
}
```

**通知内容：**
```
🚨 微信域名拦截告警

检测到域名被微信拦截：
URL：example.com
状态：微信拦截，请联系微信申诉
时间：2025-10-31 16:01:46
```

**监控版本**：通过mentioned_list和mentioned_mobile_list@指定同事
**测试版本**：标注🔧开发调试消息，不@同事

## 项目结构

```
WxCheck/
├── domain_check.py         # 单次检测工具
├── domain_monitor.py       # 定时监控工具
├── config.example.py       # 配置文件模板
├── domains.example.txt     # 域名列表模板
├── config.py               # 配置文件（需手动创建）
├── domains.txt             # 域名列表文件（需手动创建）
├── logs/                   # 检测日志目录
│   └── YYYY-MM-DD.json    # 每日检测记录
└── README.md               # 项目文档
```

## 使用场景

### 单次检测（domain_check.py）
- ✅ 测试单个域名状态
- ✅ 调试和故障排查
- ✅ 查看详细的API响应数据

### 定时监控（domain_monitor.py）
- ✅ 持续监控多个域名
- ✅ 自动预警通知
- ✅ 域名状态变化追踪
- ✅ 批量域名管理

## 注意事项

1. 仅需要安装 `requests` 库，无需 `flask`
2. 检测间隔为60秒，可在 `config.py` 中修改 `CHECK_INTERVAL` 变量
3. 域名包含特殊字符时，会自动进行URL编码
4. 企业微信机器人需要在群中配置webhook地址
5. 检测日志保存在 `logs/` 目录下，按日期分割
6. 修改 `domains.txt` 后无需重启程序，下次检测自动生效
7. 程序直接返回腾讯API的原始响应数据，控制台显示原始信息
8. 仅在微信群通知中对异常情况进行友好的提示信息
